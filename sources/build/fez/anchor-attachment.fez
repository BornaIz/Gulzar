LoadAnchors;
LoadPlugin qalamTools.CopyAnchors;
CopyAnchors SHADDA SHADDA_DAMMA;
CopyAnchors SHADDA SHADDA_KASRA;
CopyAnchors SHADDA SHADDA_FATHA;
CopyAnchors SHADDA SHADDA_LONG_A;

LoadPlugin qalamTools.QuantizeAnchors;
LoadPlugin qalamTools.DotAvoidance;

AddSpacedAnchors 150;

Feature mark {
  Routine DoMarkBase {
    Attach &top &_top bases;
    Attach &top.one &_top.one bases;
    Attach &top.two &_top.two bases;
    Attach &inside &_inside bases;
    Attach &bottom &_bottom bases;
    Attach &bottom.one &_bottom.one bases;
    Attach &bottom.two &_bottom.two bases;
    Attach &comma &_comma bases;
  };
};

Feature curs {
  Routine CursiveAttachment { Attach &entry &exit cursive; } IgnoreMarks RightToLeft;
};


Feature rlig {
  Routine SeparateConsecutiveTop {
    DetectAndSwap top;
  } UseMarkFilteringSet [toeda sda dda tda sda.one dda.one tda.one sda.two dda.two tda.two ];

  Routine SeparateConsecutiveBottom {
    DetectAndSwap bottom;
  } UseMarkFilteringSet [haydb sdb ddb tdb sdb.one ddb.one tdb.one sdb.two ddb.two tdb.two ];
};

Include "sources/build/fez/pre-mkmk-repositioning.fez";

QuantizeAnchors 10;

Feature mkmk {
  Routine DoMarkAttachment {
    Attach &top &_top marks;
    Attach &bottom &_bottom marks;
    Attach &bottom.yb &_bottom.yb marks;
  };
};
